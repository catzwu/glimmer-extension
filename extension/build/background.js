(()=>{const o=new Map,e=e=>{console.log(`[Background] Saving state for tab ${e}:`,o.get(e));const t=o.get(e)||{highlights:[],cards:[],isActive:!1};chrome.storage.local.set({[`tab_${e}`]:t})},t=(o,e)=>{console.log(`[Background] Notifying content script in tab ${o}:`,e),chrome.tabs.sendMessage(o,e).catch((o=>{console.log("[Background] Could not notify content script (tab might not be loaded yet):",o)}))},s=o=>{console.log("[Background] Notifying extension popup:",o),chrome.runtime.sendMessage(o).catch((o=>{console.log("[Background] Could not notify extension popup (might not be open):",o)}))};chrome.tabs.onRemoved.addListener((e=>{console.log(`[Background] Cleaning up data for closed tab ${e}`),o.delete(e),chrome.storage.local.remove([`tab_${e}`])})),chrome.runtime.onMessage.addListener(((c,i,a)=>{console.log("[Background] Received message:",c),console.log("[Background] From sender:",i);const r=i.tab?.id||c.tabId;switch(console.log("[Background] Using tabId:",r),c.type){case"TOGGLE_ACTIVATION":{if(!r)return console.error("[Background] No tab ID for toggle activation"),void a({success:!1,error:"No tab ID found"});console.log(`[Background] Toggling activation for tab ${r}`);const c=o.get(r)||{highlights:[],cards:[],isActive:!1};c.isActive=!c.isActive,o.set(r,c),e(r),console.log(`[Background] New activation state for tab ${r}:`,c.isActive),t(r,{type:"ACTIVATION_CHANGED",isActive:c.isActive}),s({type:"ACTIVATION_CHANGED",isActive:c.isActive,tabId:r}),a({success:!0})}break;case"GET_STATE":return r?(console.log(`[Background] Getting state for tab ${r}`),(async e=>{console.log(`[Background] Loading state for tab ${e}`);const t=(await chrome.storage.local.get([`tab_${e}`]))[`tab_${e}`]||{highlights:[],cards:[],isActive:!1};return o.set(e,t),console.log("[Background] Loaded state:",t),t})(r).then((o=>{console.log(`[Background] Sending state for tab ${r}:`,o),a(o)})),!0):(console.error("[Background] No tab ID for get state"),void a({highlights:[],cards:[],isActive:!1}));case"ADD_HIGHLIGHT":{if(!r)return console.error("[Background] No tab ID for add highlight"),void a({success:!1,error:"No tab ID found"});console.log(`[Background] Adding highlight for tab ${r}`);const t=o.get(r)||{highlights:[],cards:[],isActive:!1},g={id:c.id,text:c.text,url:i.tab?.url||"",timestamp:Date.now()};t.highlights=[...t.highlights,g],o.set(r,t),e(r),console.log(`[Background] New highlights for tab ${r}:`,t.highlights),s({type:"HIGHLIGHTS_UPDATED",highlights:t.highlights,tabId:r}),a({success:!0})}break;case"REMOVE_HIGHLIGHT":{if(!r)return console.error("[Background] No tab ID for remove highlight"),void a({success:!1,error:"No tab ID found"});console.log(`[Background] Removing highlight for tab ${r}`);const i=o.get(r)||{highlights:[],cards:[],isActive:!1};i.highlights=i.highlights.filter((o=>o.id!==c.id)),o.set(r,i),e(r),t(r,{type:"REMOVE_HIGHLIGHT_CONTENT_SCRIPT",id:c.id}),s({type:"HIGHLIGHTS_UPDATED",highlights:i.highlights,tabId:r}),a({success:!0})}break;case"CLEAR_HIGHLIGHTS":{if(!r)return console.error("[Background] No tab ID for clear highlights"),void a({success:!1,error:"No tab ID found"});console.log(`[Background] Clearing highlights for tab ${r}`);const t=o.get(r)||{highlights:[],cards:[],isActive:!1};t.highlights=[],o.set(r,t),e(r),s({type:"HIGHLIGHTS_UPDATED",highlights:t.highlights,tabId:r}),a({success:!0})}break;case"ADD_CARDS":case"REMOVE_CARD":case"CLEAR_CARDS":{if(!r)return console.error(`[Background] No tab ID for ${c.type}`),void a({success:!1,error:"No tab ID found"});console.log(`[Background] Processing ${c.type} for tab ${r}`);const t=o.get(r)||{highlights:[],cards:[],isActive:!1};switch(c.type){case"ADD_CARDS":t.cards=[...t.cards,...c.cards];break;case"REMOVE_CARD":t.cards=t.cards.filter(((o,e)=>e!==c.index));break;case"CLEAR_CARDS":t.cards=[]}o.set(r,t),e(r),a({success:!0})}}}))})();