(()=>{const o=new Map,e=e=>{console.log(`[Background] Saving state for tab ${e}:`,o.get(e));const t=o.get(e)||{highlights:[],cards:[],isActive:!1};chrome.storage.local.set({[`tab_${e}`]:t})},t=(o,e)=>{console.log(`[Background] Notifying content script in tab ${o}:`,e),chrome.tabs.sendMessage(o,e).catch((o=>{console.log("[Background] Could not notify content script (tab might not be loaded yet):",o)}))},s=o=>{console.log("[Background] Notifying extension popup:",o),chrome.runtime.sendMessage(o).catch((o=>{console.log("[Background] Could not notify extension popup (might not be open):",o)}))};chrome.tabs.onRemoved.addListener((e=>{console.log(`[Background] Cleaning up data for closed tab ${e}`),o.delete(e),chrome.storage.local.remove([`tab_${e}`])})),chrome.runtime.onMessage.addListener(((c,r,i)=>{console.log("[Background] Received message:",c),console.log("[Background] From sender:",r);const a=r.tab?.id||c.tabId;switch(console.log("[Background] Using tabId:",a),c.type){case"GET_CURRENT_TAB_ID":return r.tab?.id?(console.log("[Background] Returning current tab ID from sender:",r.tab.id),void i({tabId:r.tab.id})):(chrome.tabs.query({active:!0,currentWindow:!0},(o=>{const e=o[0]?.id;console.log("[Background] Returning current tab ID from query:",e),i({tabId:e})})),!0);case"TOGGLE_ACTIVATION":{if(!a)return console.error("[Background] No tab ID for toggle activation"),void i({success:!1,error:"No tab ID found"});console.log(`[Background] Toggling activation for tab ${a}`);const c=o.get(a)||{highlights:[],cards:[],isActive:!1};c.isActive=!c.isActive,o.set(a,c),e(a),console.log(`[Background] New activation state for tab ${a}:`,c.isActive),t(a,{type:"ACTIVATION_CHANGED",isActive:c.isActive}),s({type:"ACTIVATION_CHANGED",isActive:c.isActive,tabId:a}),i({success:!0})}break;case"GET_STATE":return a?(console.log(`[Background] Getting state for tab ${a}`),(async e=>{console.log(`[Background] Loading state for tab ${e}`);const t=(await chrome.storage.local.get([`tab_${e}`]))[`tab_${e}`]||{highlights:[],cards:[],isActive:!1};return o.set(e,t),console.log("[Background] Loaded state:",t),t})(a).then((o=>{console.log(`[Background] Sending state for tab ${a}:`,o),i(o)})),!0):(console.error("[Background] No tab ID for get state"),void i({highlights:[],cards:[],isActive:!1}));case"ADD_HIGHLIGHT":{if(!a)return console.error("[Background] No tab ID for add highlight"),void i({success:!1,error:"No tab ID found"});console.log(`[Background] Adding highlight for tab ${a}`);const t=o.get(a)||{highlights:[],cards:[],isActive:!1},g={id:c.id,text:c.text,url:r.tab?.url||"",timestamp:Date.now()};t.highlights=[...t.highlights,g],o.set(a,t),e(a),console.log(`[Background] New highlights for tab ${a}:`,t.highlights),s({type:"HIGHLIGHTS_UPDATED",highlights:t.highlights,tabId:a}),i({success:!0})}break;case"REMOVE_HIGHLIGHT":{if(!a)return console.error("[Background] No tab ID for remove highlight"),void i({success:!1,error:"No tab ID found"});console.log(`[Background] Removing highlight for tab ${a}`);const r=o.get(a)||{highlights:[],cards:[],isActive:!1};r.highlights=r.highlights.filter((o=>o.id!==c.id)),o.set(a,r),e(a),t(a,{type:"REMOVE_HIGHLIGHT_CONTENT_SCRIPT",id:c.id}),s({type:"HIGHLIGHTS_UPDATED",highlights:r.highlights,tabId:a}),i({success:!0})}break;case"CLEAR_HIGHLIGHTS":{if(!a)return console.error("[Background] No tab ID for clear highlights"),void i({success:!1,error:"No tab ID found"});console.log(`[Background] Clearing highlights for tab ${a}`);const t=o.get(a)||{highlights:[],cards:[],isActive:!1};t.highlights=[],o.set(a,t),e(a),s({type:"HIGHLIGHTS_UPDATED",highlights:t.highlights,tabId:a}),i({success:!0})}break;case"ADD_CARDS":case"REMOVE_CARD":case"CLEAR_CARDS":{if(!a)return console.error(`[Background] No tab ID for ${c.type}`),void i({success:!1,error:"No tab ID found"});console.log(`[Background] Processing ${c.type} for tab ${a}`);const t=o.get(a)||{highlights:[],cards:[],isActive:!1};switch(c.type){case"ADD_CARDS":t.cards=[...t.cards,...c.cards];break;case"REMOVE_CARD":t.cards=t.cards.filter(((o,e)=>e!==c.index));break;case"CLEAR_CARDS":t.cards=[]}o.set(a,t),e(a),i({success:!0})}}}))})();