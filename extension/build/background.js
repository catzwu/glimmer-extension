(()=>{let e=!0,s=[],c=[];chrome.storage.local.get(["highlights","cards","isActive"],(i=>{s=i.highlights||[],c=i.cards||[],e=i.isActive??!0}));const i=()=>{chrome.storage.local.set({highlights:s,cards:c,isActive:e})};chrome.runtime.onMessage.addListener(((t,a,r)=>{switch(console.log("Background received:",t.type),t.type){case"TOGGLE_ACTIVATION":e=t.isActive??!e,i(),chrome.tabs.query({},(s=>{s.forEach((s=>{s.id&&chrome.tabs.sendMessage(s.id,{type:"EXTENSION_STATE",isActive:e}).catch((()=>{}))}))})),r({success:!0});break;case"GET_EXTENSION_STATE":r({isActive:e,highlights:s,cards:c});break;case"ADD_HIGHLIGHT":if(t.text){const e={id:t.id,text:t.text,url:a.tab?.url||"",timestamp:Date.now()};s=[...s,e],i(),chrome.runtime.sendMessage({type:"HIGHLIGHTS_UPDATED",highlights:s}).catch((()=>{}))}r({success:!0});break;case"REMOVE_HIGHLIGHT":console.log("Removing highlight (background):",t.id),t.id?(s=s.filter((e=>e.id!==t.id)),i(),r({success:!0}),console.log("Notifying popup of removed highlight:",t.id),chrome.runtime.sendMessage({type:"HIGHLIGHTS_UPDATED",highlights:s}).catch((()=>{})),chrome.tabs.query({},(e=>{e.forEach((e=>{e.id&&chrome.tabs.sendMessage(e.id,{type:"REMOVE_HIGHLIGHT_CONTENT_SCRIPT",id:t.id}).catch((()=>{}))}))}))):r({error:"Invalid highlight ID"});break;case"ADD_CARDS":t.card?(c=[...c,...t.cards],i(),r({success:!0})):r({error:"Invalid card data"});break;case"CLEAR_HIGHLIGHTS":s=[],i(),r({success:!0});break;case"CLEAR_CARDS":c=[],i(),r({success:!0});break;case"GET_HIGHLIGHTS":r({highlights:s});break;case"GET_CARDS":r({cards:c});break;default:r({error:"Unknown message type"})}return!0}))})();