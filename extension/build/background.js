(()=>{let e=!0,s=[],c=[];chrome.storage.local.get(["highlights","cards","isActive"],(i=>{s=i.highlights||[],c=i.cards||[],e=i.isActive??!0}));const i=()=>{chrome.storage.local.set({highlights:s,cards:c,isActive:e})};chrome.runtime.onMessage.addListener(((a,r,t)=>{switch(console.log("Background received:",a.type),a.type){case"TOGGLE_ACTIVATION":e=a.isActive,i(),chrome.tabs.query({},(s=>{s.forEach((s=>{s.id&&chrome.tabs.sendMessage(s.id,{type:"EXTENSION_STATE",isActive:e}).catch((()=>{}))}))})),t({success:!0});break;case"GET_EXTENSION_STATE":t({isActive:e,highlights:s,cards:c});break;case"ADD_HIGHLIGHT":if(a.text){const e={id:a.id,text:a.text,url:r.tab?.url||"",timestamp:Date.now()};s=[...s,e],i(),chrome.runtime.sendMessage({type:"HIGHLIGHTS_UPDATED",highlights:s}).catch((()=>{}))}t({success:!0});break;case"REMOVE_HIGHLIGHT":console.log("Removing highlight (background):",a.id),a.id?(s=s.filter((e=>e.id!==a.id)),i(),t({success:!0}),console.log("Notifying popup of removed highlight:",a.id),chrome.runtime.sendMessage({type:"HIGHLIGHTS_UPDATED",highlights:s}).catch((()=>{})),chrome.tabs.query({},(e=>{e.forEach((e=>{e.id&&chrome.tabs.sendMessage(e.id,{type:"REMOVE_HIGHLIGHT_CONTENT_SCRIPT",id:a.id}).catch((()=>{}))}))}))):t({error:"Invalid highlight ID"});break;case"ADD_CARDS":a.cards?(console.log("Background adding cards:",a.cards),c=a.cards,i(),t({success:!0})):t({error:"Invalid card data"});break;case"REMOVE_CARD":void 0!==a.index?(console.log("Background removing card at index:",a.index),c.splice(a.index,1),i(),t({success:!0})):t({error:"Invalid card index"});break;case"CLEAR_HIGHLIGHTS":s=[],i(),t({success:!0});break;case"CLEAR_CARDS":c=[],i(),t({success:!0});break;case"GET_HIGHLIGHTS":t({highlights:s});break;case"GET_CARDS":t({cards:c});break;default:t({error:"Unknown message type"})}return!0}))})();