(()=>{const o=new Map,e=e=>{console.log(`[Background] Saving state for tab ${e}:`,o.get(e));const t=o.get(e)||{highlights:[],cards:[],isActive:!1};chrome.storage.local.set({[`tab_${e}`]:t})},t=(o,e)=>{console.log(`[Background] Notifying content script in tab ${o}:`,e),chrome.tabs.sendMessage(o,e).catch((o=>{console.log("[Background] Could not notify content script (tab might not be loaded yet):",o)}))},s=o=>{console.log("[Background] Notifying extension popup:",o),chrome.runtime.sendMessage(o).catch((o=>{console.log("[Background] Could not notify extension popup (might not be open):",o)}))};chrome.tabs.onRemoved.addListener((e=>{console.log(`[Background] Cleaning up data for closed tab ${e}`),o.delete(e),chrome.storage.local.remove([`tab_${e}`])})),chrome.action.onClicked.addListener((o=>{console.log("[Background] Opening side panel for tab:",o.id),chrome.sidePanel.setOptions({path:"index.html",enabled:!0}),chrome.sidePanel.open({windowId:o.windowId}).catch((o=>{console.error("[Background] Error opening side panel:",o)}))})),chrome.tabs.onActivated.addListener((o=>{console.log("[Background] Tab activated:",o),o.tabId&&(console.log("[Background] Disabling side panel for new tab"),chrome.sidePanel.setOptions({enabled:!1}))})),chrome.runtime.onMessage.addListener(((c,a,r)=>{console.log("[Background] Received message:",c),console.log("[Background] From sender:",a);const i=a.tab?.id||c.tabId;switch(console.log("[Background] Using tabId:",i),c.type){case"CLOSE_SIDE_PANEL":return console.log("[Background] Handling close side panel request for tab:",c.tabId),chrome.sidePanel.setOptions({enabled:!1}).then((()=>{console.log("[Background] Side panel closed successfully"),r({success:!0})})).catch((o=>{console.error("[Background] Error closing side panel:",o),r({success:!1,error:o})})),!0;case"TOGGLE_ACTIVATION":{if(!i)return console.error("[Background] No tab ID for toggle activation"),void r({success:!1,error:"No tab ID found"});console.log(`[Background] Toggling activation for tab ${i}`);const c=o.get(i)||{highlights:[],cards:[],isActive:!1};c.isActive=!c.isActive,o.set(i,c),e(i),console.log(`[Background] New activation state for tab ${i}:`,c.isActive),t(i,{type:"ACTIVATION_CHANGED",isActive:c.isActive}),s({type:"ACTIVATION_CHANGED",isActive:c.isActive,tabId:i}),r({success:!0})}break;case"GET_STATE":return i?(console.log(`[Background] Getting state for tab ${i}`),(async e=>{console.log(`[Background] Loading state for tab ${e}`);const t=(await chrome.storage.local.get([`tab_${e}`]))[`tab_${e}`]||{highlights:[],cards:[],isActive:!1};return o.set(e,t),console.log("[Background] Loaded state:",t),t})(i).then((o=>{console.log(`[Background] Sending state for tab ${i}:`,o),r(o)})),!0):(console.error("[Background] No tab ID for get state"),void r({highlights:[],cards:[],isActive:!1}));case"ADD_HIGHLIGHT":{if(!i)return console.error("[Background] No tab ID for add highlight"),void r({success:!1,error:"No tab ID found"});console.log(`[Background] Adding highlight for tab ${i}`);const t=o.get(i)||{highlights:[],cards:[],isActive:!1},n={id:c.id,text:c.text,url:a.tab?.url||"",timestamp:Date.now()};t.highlights=[...t.highlights,n],o.set(i,t),e(i),console.log(`[Background] New highlights for tab ${i}:`,t.highlights),s({type:"HIGHLIGHTS_UPDATED",highlights:t.highlights,tabId:i}),r({success:!0})}break;case"REMOVE_HIGHLIGHT":{if(!i)return console.error("[Background] No tab ID for remove highlight"),void r({success:!1,error:"No tab ID found"});console.log(`[Background] Removing highlight for tab ${i}`);const a=o.get(i)||{highlights:[],cards:[],isActive:!1};a.highlights=a.highlights.filter((o=>o.id!==c.id)),o.set(i,a),e(i),t(i,{type:"REMOVE_HIGHLIGHT_CONTENT_SCRIPT",id:c.id}),s({type:"HIGHLIGHTS_UPDATED",highlights:a.highlights,tabId:i}),r({success:!0})}break;case"CLEAR_HIGHLIGHTS":{if(!i)return console.error("[Background] No tab ID for clear highlights"),void r({success:!1,error:"No tab ID found"});console.log(`[Background] Clearing highlights for tab ${i}`);const t=o.get(i)||{highlights:[],cards:[],isActive:!1};t.highlights=[],o.set(i,t),e(i),s({type:"HIGHLIGHTS_UPDATED",highlights:t.highlights,tabId:i}),r({success:!0})}break;case"ADD_CARDS":case"REMOVE_CARD":case"CLEAR_CARDS":{if(!i)return console.error(`[Background] No tab ID for ${c.type}`),void r({success:!1,error:"No tab ID found"});console.log(`[Background] Processing ${c.type} for tab ${i}`);const t=o.get(i)||{highlights:[],cards:[],isActive:!1};switch(c.type){case"ADD_CARDS":t.cards=[...t.cards,...c.cards];break;case"REMOVE_CARD":t.cards=t.cards.filter(((o,e)=>e!==c.index));break;case"CLEAR_CARDS":t.cards=[]}o.set(i,t),e(i),r({success:!0})}}}))})();