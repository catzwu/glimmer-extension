(()=>{let e=!0,s=[],c=[];chrome.storage.local.get(["highlights","cards","isActive"],(a=>{s=a.highlights||[],c=a.cards||[],e=a.isActive??!0}));const a=()=>{chrome.storage.local.set({highlights:s,cards:c,isActive:e})};chrome.runtime.onMessage.addListener(((i,t,r)=>{switch(console.log("Background received:",i.type),i.type){case"TOGGLE_ACTIVATION":e=i.isActive,a(),chrome.tabs.query({},(s=>{s.forEach((s=>{s.id&&chrome.tabs.sendMessage(s.id,{type:"EXTENSION_STATE",isActive:e}).catch((()=>{}))}))})),r({success:!0});break;case"GET_EXTENSION_STATE":r({isActive:e,highlights:s,cards:c});break;case"ADD_HIGHLIGHT":if(i.text){const e={id:i.id,text:i.text,url:t.tab?.url||"",timestamp:Date.now()};s=[...s,e],a(),chrome.runtime.sendMessage({type:"HIGHLIGHTS_UPDATED",highlights:s}).catch((()=>{}))}r({success:!0});break;case"REMOVE_HIGHLIGHT":console.log("Removing highlight (background):",i.id),i.id?(s=s.filter((e=>e.id!==i.id)),a(),r({success:!0}),console.log("Notifying popup of removed highlight:",i.id),chrome.runtime.sendMessage({type:"HIGHLIGHTS_UPDATED",highlights:s}).catch((()=>{})),chrome.tabs.query({},(e=>{e.forEach((e=>{e.id&&chrome.tabs.sendMessage(e.id,{type:"REMOVE_HIGHLIGHT_CONTENT_SCRIPT",id:i.id}).catch((()=>{}))}))}))):r({error:"Invalid highlight ID"});break;case"ADD_CARDS":i.cards?(console.log("Background adding cards:",i.cards),c=i.cards,a(),r({success:!0})):r({error:"Invalid card data"});break;case"CLEAR_HIGHLIGHTS":s=[],a(),r({success:!0});break;case"CLEAR_CARDS":c=[],a(),r({success:!0});break;case"GET_HIGHLIGHTS":r({highlights:s});break;case"GET_CARDS":r({cards:c});break;default:r({error:"Unknown message type"})}return!0}))})();